---
title: "NILT"
---



```{r}
#| include: FALSE

library(here)
source(paste0(here(), "/data_prep/main_data_prep.R"))
```

## Row

### Column {width=50%}

```{r}

plot_ly() %>%
  add_trace(data = nilt_historical_chart1, x = ~year, y = ~GBVPHYVA, type = 'scatter',
            mode = 'lines+markers', name = 'Physical violence',
            line = list(color = nisra_colours[1]),
            marker = list(color = nisra_colours[1]),
            hovertemplate = "Year: %{x}<br>Value: %{y:.2f}%<extra></extra>") %>%
  add_trace(data = nilt_historical_chart1, x = ~year, y = ~GBVSEXVA, type = 'scatter',
            mode = 'lines+markers', name = 'Sexual violence',
            line = list(color = nisra_colours[2]),
            marker = list(color = nisra_colours[2]),
            hovertemplate = "Year: %{x}<br>Value: %{y:.2f}%<extra></extra>") %>%
  add_trace(data = nilt_historical_chart1, x = ~year, y = ~GBVPSYVA, type = 'scatter',
            mode = 'lines+markers', name = 'Psychological violence',
            line = list(color = nisra_colours[3]),
            marker = list(color = nisra_colours[3]),
            hovertemplate = "Year: %{x}<br>Value: %{y:.2f}%<extra></extra>") %>%
  add_trace(data = nilt_historical_chart1, x = ~year, y = ~GBVECONV, type = 'scatter',
            mode = 'lines+markers', name = 'Economic violence',
            line = list(color = nisra_colours[4]),
            marker = list(color = nisra_colours[4]),
            hovertemplate = "Year: %{x}<br>Value: %{y:.2f}%<extra></extra>") %>%
  add_trace(data = nilt_historical_chart1, x = ~year, y = ~GBVONLV, type = 'scatter',
            mode = 'lines+markers', name = 'Online violence',
            line = list(color = nisra_colours[5]),
            marker = list(color = nisra_colours[5]),
            hovertemplate = "Year: %{x}<br>Value: %{y:.2f}%<extra></extra>") %>%
  layout(
    title = list(
      text = "Experienced Violence Over Time",
      y = 0.98,
      x = 0.5,
      xanchor = "center"
    ),
    margin = list(t = 100),
    xaxis = list(
      title = list(
        text = "Year",
        font = list(size = 14)
      ),
      tickmode = "array",
      tickvals = nilt_historical_chart1$year,
      showgrid = FALSE,
    showline = TRUE,  
    linecolor = "black", 
    linewidth = 1 
    ),
    yaxis = list(
      title = "",  
      automargin = TRUE,
      titlefont = list(size = 0),
      standoff = 0,
      showgrid = FALSE,
    showline = TRUE, 
    linecolor = "black",
    linewidth = 1
    ),
    legend = list(title = list(text = "")),
    annotations = list(
      list(
        x = -0.008,
        xref = "paper",
        xanchor = "center",
        y = 1.1,
        yref = "paper",
        yanchor = "bottom",
        text = "Percentage %",
        showarrow = FALSE,
        font = list(size = 14)
      )
    )
  )%>%
  config(displayModeBar = FALSE)

```


### Column {width=50%}

```{r}

# Ensure year is numeric
nilt_historical_chart2 <- nilt_historical_chart2 %>%
  mutate(year = as.numeric(year)) %>%
  arrange(variable, gender, year)

# Extract colours from nisra_colours
male_colour <- nisra_colours[1]
female_colour <- nisra_colours[2]

# Create initial plot
plt <- plot_ly(
  data = nilt_historical_chart2 %>% filter(variable == "GBVSEXVA"),
  x = ~year,
  y = ~percentage_yes,
  color = ~gender,
  type = "scatter",
  mode = "lines+markers",
  hovertemplate = "Year: %{x}<br>Gender: %{color}<br>% Yes: %{y:.1f}%%<extra></extra>"
) %>%
  layout(
    title = "Sexual Violence: Percentage Breakdown by Gender",
    xaxis = list(
      title = "Year",
      tickformat = ".0f",
      dtick = 1,
      tickmode = "linear",
      showgrid = FALSE,
      showline = TRUE,
      linecolor = "black",
      linewidth = 1
    ),
    yaxis = list(
      title = "",
      showgrid = FALSE,
      showline = TRUE,
      linecolor = "black",
      linewidth = 1
    ),
    legend = list(title = list(text = "Gender")),
    annotations = list(
      list(
        x = -0.1,
        y = 1.05,
        text = "Percentage %",
        xref = "paper",
        yref = "paper",
        showarrow = FALSE,
        font = list(size = 14)
      )
    )
  )

# Convert data to JSON
data_json <- toJSON(nilt_historical_chart2, auto_unbox = TRUE)

# JavaScript for dropdown and dynamic chart update
js_code <- glue("
  function(el, x) {{
    const container = document.createElement('div');
    container.style.marginBottom = '10px';
    const label = document.createElement('label');
    label.innerText = 'Select a Variable:   ';
    const select = document.createElement('select');

    const data = {data_json};

    const variableLabels = {{
      'GBVECONV': 'Economic Violence',
      'GBVONLV': 'Online Violence',
      'GBVPHYVA': 'Physical Violence',
      'GBVPSYVA': 'Psychological Violence',
      'GBVSEXVA': 'Sexual Violence'
    }};

    const variables = [...new Set(data.map(d => d.variable))];
    variables.forEach(v => {{
      const opt = document.createElement('option');
      opt.value = v;
      opt.text = variableLabels[v] || v;
      if (v === 'GBVSEXVA') opt.selected = true;
      select.appendChild(opt);
    }});

    container.appendChild(label);
    container.appendChild(select);
    el.parentNode.insertBefore(container, el);

    function updateChart(selectedVar) {{
      const filtered = data.filter(d => d.variable === selectedVar);
      const male = filtered.filter(d => d.gender === 'Male');
      const female = filtered.filter(d => d.gender === 'Female');

      Plotly.react(el, [
        {{
          x: male.map(d => d.year),
          y: male.map(d => d.percentage_yes),
          type: 'scatter',
          mode: 'lines+markers',
          name: 'Male',
          line: {{ color: '{male_colour}' }},
          marker: {{ color: '{male_colour}' }}
        }},
        {{
          x: female.map(d => d.year),
          y: female.map(d => d.percentage_yes),
          type: 'scatter',
          mode: 'lines+markers',
          name: 'Female',
          line: {{ color: '{female_colour}' }},
          marker: {{ color: '{female_colour}' }}
        }}
      ],
      {{
        title: variableLabels[selectedVar] + ': Percentage Breakdown by Gender',
        xaxis: {{
          title: 'Year',
          tickformat: '.0f',
          dtick: 1,
          tickmode: 'linear',
          showgrid: false,
          showline: true,
          linecolor: 'black',
          linewidth: 1
        }},
        yaxis: {{
          title: '',
          showgrid: false,
          showline: true,
          linecolor: 'black',
          linewidth: 1
        }},
        legend: {{ title: {{ text: 'Gender' }} }},
        annotations: [{{
          x: -0.11,
          y: 1.115,
          text: 'Percentage %',
          xref: 'paper',
          yref: 'paper',
          showarrow: false,
          font: {{ size: 14 }}
        }}]
      }});
    }}

    select.addEventListener('change', function() {{
      updateChart(this.value);
    }});

    updateChart(select.value);
  }}
")

# Attach JavaScript to plot

plt <- config(plt, displayModeBar = FALSE)
onRender(plt, js_code)





```
